<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PWA POS System</title>
<link rel="manifest" href="manifest.json">
<style>
  :root{
    --bg:#f2f4f7; --card:#fff; --accent:#0066ff; --fg:#111;
  }
  [data-theme="dark"]{ --bg:#0e0f12; --card:#131416; --accent:#4d8dff; --fg:#eee; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, Roboto, Arial; background:var(--bg); color:var(--fg); min-height:100vh; display:flex; flex-direction:column;}
  header{padding:14px 18px; background:var(--card); display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .title{font-weight:700}
  .top-actions{display:flex; gap:8px}
  .btn{background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer}
  .tabs{display:flex; gap:8px; padding:10px; background:transparent; overflow:auto}
  .tab{padding:10px 12px; background:transparent; border-radius:10px; cursor:pointer; font-weight:600}
  .tab.active{background:var(--card); box-shadow:0 2px 8px rgba(0,0,0,.06); color:var(--accent)}
  .wrap{padding:16px; flex:1; overflow:auto}
  .card{background:var(--card); padding:16px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.04); margin-bottom:12px}
  label{display:block;font-weight:600;margin-top:8px}
  input, select{width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px}
  table{width:100%; border-collapse:collapse;}
  th,td{padding:8px; border-bottom:1px solid #eee; text-align:left}
  .small{font-size:13px;color:#666}
  .right{text-align:right}
  .row{display:flex; gap:12px; align-items:center}
  .col{flex:1}
  .ghost{background:transparent;border:1px solid #ddd;color:var(--fg);padding:9px 12px;border-radius:8px;cursor:pointer}
  #installBtn{display:none}
  .statusbar{padding:8px 12px; font-size:14px;}
  .badge{background:#eee;padding:6px 8px;border-radius:8px;font-weight:700}
</style>
</head>
<body data-theme="light">

<header>
  <div class="title">Hardware POS</div>
  <div class="top-actions">
    <div class="small badge" id="connStatus">Offline</div>
    <button id="themeToggle" class="ghost">Theme</button>
    <button id="installBtn" class="btn">Install</button>
  </div>
</header>

<div class="tabs" id="tabs">
  <div class="tab active" data-tab="pos">POS</div>
  <div class="tab" data-tab="cart">Cart</div>
  <div class="tab" data-tab="history">Sales History</div>
  <div class="tab" data-tab="customers">Customers</div>
  <div class="tab" data-tab="payments">Payments</div>
  <div class="tab" data-tab="login">Login</div>
</div>

<div class="wrap">
  <!-- POS -->
  <div id="pos" class="tabpane">
    <div class="card">
      <h3>Quick Add Item (free-text)</h3>
      <div class="row">
        <input id="itemDesc" placeholder="Item description (e.g., 3/4\" elbow 1pc)" class="col" />
        <input id="itemQty" placeholder="Qty" style="width:110px" type="number" value="1" />
        <input id="itemPrice" placeholder="Price" style="width:140px" type="number" />
        <button class="btn" onclick="addToCart()">Add</button>
      </div>
    </div>

    <div class="card">
      <h3>Customer & Payment</h3>
      <label>Customer ID (optional)</label>
      <input id="posCustomer" placeholder="CUST-0001 or leave blank for walk-in" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <select id="posPayment" style="flex:1">
          <option>Cash</option><option>GCash</option><option>Charge</option>
        </select>
        <button class="ghost" onclick="clearCart()">Clear Cart</button>
      </div>
      <div style="margin-top:12px">
        <button class="btn" onclick="checkout()">Checkout</button>
      </div>
    </div>

    <div class="card">
      <h3>Cart Preview</h3>
      <div id="cartContainer" style="max-height:260px; overflow:auto"></div>
      <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center">
        <div class="small">Total</div>
        <div id="cartTotal" style="font-weight:800">0.00</div>
      </div>
    </div>
  </div>

  <!-- Cart Tab (same as cart preview but full) -->
  <div id="cart" class="tabpane" style="display:none">
    <div class="card">
      <h3>Cart (edit qty or remove)</h3>
      <div id="cartFull"></div>
      <div style="margin-top:12px; display:flex; gap:8px">
        <button class="btn" onclick="checkout()">Checkout</button>
        <button class="ghost" onclick="clearCart()">Clear</button>
      </div>
    </div>
  </div>

  <!-- Sales History -->
  <div id="history" class="tabpane" style="display:none">
    <div class="card">
      <h3>Recent Sales</h3>
      <div id="salesList" class="small">Loading…</div>
    </div>
  </div>

  <!-- Customers -->
  <div id="customers" class="tabpane" style="display:none">
    <div class="card">
      <h3>Add Customer</h3>
      <label>Name</label><input id="custName" placeholder="Name" />
      <label>Contact</label><input id="custContact" placeholder="Phone/Email" />
      <button class="btn" onclick="submitCustomer()">Save</button>
    </div>
  </div>

  <!-- Payments -->
  <div id="payments" class="tabpane" style="display:none">
    <div class="card">
      <h3>Record Payment</h3>
      <label>Sale ID</label><input id="paySaleId" placeholder="SALE-000001" />
      <label>Amount</label><input id="payAmt" type="number" />
      <label>Type</label>
      <select id="payType"><option>Cash</option><option>GCash</option><option>Check</option></select>
      <button class="btn" onclick="submitPayment()">Submit Payment</button>
    </div>
  </div>

  <!-- Login -->
  <div id="login" class="tabpane" style="display:none">
    <div class="card" id="loginCard">
      <h3>Sign In</h3>
      <label>Username</label><input id="loginUser" />
      <label>Password</label><input id="loginPass" type="password" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="ghost" onclick="logout()">Logout</button>
      </div>
      <div id="loginMessage" class="small" style="margin-top:8px"></div>
    </div>
    <div id="whoami" class="card" style="display:none">
      <h3>Current User</h3>
      <div id="curUser"></div>
    </div>
  </div>

</div>

<script>
/* ---------------- CONFIG ---------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbzBV5P0P7hVkO6nXDXwytjithPSgVkcEQ635VLlagpaBoDkGfyXiDIPpkNe87s9lfXF/exec"; // <-- replace with your /exec URL
const QUEUE_KEY = "pos_offline_queue_v1";

/* ---------------- STATE ---------------- */
let cart = JSON.parse(localStorage.getItem('pos_cart')||'[]');
let currentUser = JSON.parse(localStorage.getItem('pos_user')||'null');

/* ---------------- UI: Tabs ---------------- */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.addEventListener('click', ()=> {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('.tabpane').forEach(p=>p.style.display='none');
  document.getElementById(t.dataset.tab).style.display='block';
  if(t.dataset.tab==='history') loadSalesHistory();
  if(t.dataset.tab==='cart') renderCartFull();
  if(t.dataset.tab==='login') renderWhoami();
}));

/* ---------------- THEME ---------------- */
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme')==='dark'?'light':'dark';
  document.body.setAttribute('data-theme', cur);
  localStorage.setItem('theme', cur);
});
document.body.setAttribute('data-theme', localStorage.getItem('theme')||'light');

/* ---------------- CONNECTION STATUS ---------------- */
function updateConn(){
  const online = navigator.onLine;
  document.getElementById('connStatus').innerText = online ? 'Online' : 'Offline';
}
window.addEventListener('online', ()=>{ updateConn(); syncQueue(); loadSalesHistory(); });
window.addEventListener('offline', updateConn);
updateConn();

/* ---------------- CART UI ---------------- */
function renderCart(){
  const el = document.getElementById('cartContainer');
  if(!cart.length){ el.innerHTML = '<div class="small">Cart is empty</div>'; document.getElementById('cartTotal').innerText='0.00'; return; }
  let html = '<table><thead><tr><th>Item</th><th>Qty</th><th class="right">Line</th></tr></thead><tbody>';
  let total=0;
  cart.forEach((it,idx)=>{
    const line = (it.qty||1)*(Number(it.price)||0);
    total += line;
    html += `<tr><td>${it.desc}</td><td>${it.qty}</td><td class="right">${line.toFixed(2)}</td></tr>`;
  });
  html += `</tbody></table>`;
  el.innerHTML = html;
  document.getElementById('cartTotal').innerText = total.toFixed(2);
  localStorage.setItem('pos_cart', JSON.stringify(cart));
}
function renderCartFull(){
  const el = document.getElementById('cartFull');
  if(!cart.length){ el.innerHTML = '<div class="small">Cart is empty</div>'; return; }
  let html = '<table><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th></th></tr></thead><tbody>';
  cart.forEach((it,idx)=>{
    html += `<tr><td>${it.desc}</td><td><input style="width:70px" value="${it.qty}" onchange="updateQty(${idx},this.value)"></td><td><input style="width:90px" value="${it.price}" onchange="updatePrice(${idx},this.value)"></td><td><button class="ghost" onclick="removeItem(${idx})">Remove</button></td></tr>`;
  });
  html += `</tbody></table>`;
  el.innerHTML = html;
}
function addToCart(){
  const desc = document.getElementById('itemDesc').value.trim();
  const qty = Number(document.getElementById('itemQty').value) || 1;
  const price = Number(document.getElementById('itemPrice').value) || 0;
  if(!desc){ alert('Add an item description'); return; }
  cart.push({desc, qty, price});
  document.getElementById('itemDesc').value=''; document.getElementById('itemPrice').value=''; document.getElementById('itemQty').value=1;
  renderCart(); renderCartFull();
}
function updateQty(i,v){ cart[i].qty = Number(v)||1; renderCart(); renderCartFull(); }
function updatePrice(i,v){ cart[i].price = Number(v)||0; renderCart(); renderCartFull(); }
function removeItem(i){ cart.splice(i,1); renderCart(); renderCartFull(); }
function clearCart(){ if(confirm('Clear cart?')){ cart=[]; renderCart(); renderCartFull(); } }

/* ---------------- CHECKOUT / SUBMIT SALE ---------------- */
async function checkout(){
  if(!cart.length){ alert('Cart is empty'); return; }
  const sale = {
    date: new Date().toISOString(),
    invoiceNo: 'SI-'+Date.now(),
    customerID: document.getElementById('posCustomer').value || '',
    items: cart,
    totalAmount: cart.reduce((s,it)=>s + (Number(it.price)||0)*(it.qty||1), 0),
    paymentType: document.getElementById('posPayment').value || 'Cash',
    user: currentUser ? currentUser.Username : 'Guest'
  };
  await submitAction('addSale', sale);
  cart = []; localStorage.setItem('pos_cart', JSON.stringify(cart)); renderCart(); renderCartFull();
  alert('Sale queued/submitted');
}

/* ---------------- SUBMIT / OFFLINE QUEUE ---------------- */
async function submitAction(action, data){
  // include user if logged in
  if(currentUser) data.user = currentUser.Username;
  // try online first
  if(navigator.onLine){
    try{
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action, data})
      });
      const json = await res.json();
      if(json.status === 'success') return json;
      // otherwise fall back to queue
    }catch(err){
      console.warn('submit failed, queueing', err);
    }
  }
  // push to queue
  const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
  q.push({action,data,ts:new Date().toISOString()});
  localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
  return {status:'queued'};
}
async function syncQueue(){
  const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
  if(!q.length) return;
  for(const item of q.slice()){ // copy
    try{
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:item.action, data:item.data})
      });
      const json = await res.json();
      if(json.status==='success'){
        // remove from queue
        const current = JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
        // drop first matching by ts
        const idx = current.findIndex(x=>x.ts===item.ts);
        if(idx!==-1){ current.splice(idx,1); localStorage.setItem(QUEUE_KEY, JSON.stringify(current)); }
      } else {
        console.warn('sync returned non-success', json);
        break;
      }
    }catch(e){
      console.warn('sync failed', e);
      break;
    }
  }
}

/* ---------------- CUSTOMERS / PAYMENTS ---------------- */
async function submitCustomer(){
  const name = document.getElementById('custName').value.trim();
  const contact = document.getElementById('custContact').value.trim();
  if(!name){ alert('Name required'); return; }
  await submitAction('addCustomer', {name, contact});
  alert('Customer queued/submitted');
  document.getElementById('custName').value=''; document.getElementById('custContact').value='';
}
async function submitPayment(){
  const saleID = document.getElementById('paySaleId').value.trim();
  const amount = Number(document.getElementById('payAmt').value) || 0;
  const type = document.getElementById('payType').value;
  if(!saleID || amount<=0){ alert('Sale ID and amount required'); return; }
  await submitAction('addPayment', {saleID, amount, type});
  alert('Payment queued/submitted');
  document.getElementById('paySaleId').value=''; document.getElementById('payAmt').value='';
}

/* ---------------- LOGIN ---------------- */
async function doLogin(){
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;
  if(!username || !password){ document.getElementById('loginMessage').innerText='Enter username/password'; return; }
  // send login request (server will hash & verify)
  try{
    const res = await fetch(API_URL,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'login', data:{username, password}})});
    const json = await res.json();
    if(json.status==='success'){
      currentUser = json.user;
      localStorage.setItem('pos_user', JSON.stringify(currentUser));
      document.getElementById('loginMessage').innerText = 'Login successful';
      renderWhoami();
    } else {
      document.getElementById('loginMessage').innerText = json.message || 'Login failed';
    }
  }catch(e){
    document.getElementById('loginMessage').innerText = 'Login error (offline?)';
  }
}
function logout(){
  currentUser = null; localStorage.removeItem('pos_user'); renderWhoami(); alert('Logged out');
}
function renderWhoami(){
  if(currentUser){
    document.getElementById('loginCard').style.display='none';
    document.getElementById('whoami').style.display='block';
    document.getElementById('curUser').innerText = `${currentUser.Name} (${currentUser.Role})`;
  } else {
    document.getElementById('loginCard').style.display='block';
    document.getElementById('whoami').style.display='none';
  }
}

/* ---------------- SALES HISTORY (calls API) ---------------- */
async function loadSalesHistory(){
  const el = document.getElementById('salesList'); el.innerText='Loading...';
  if(!navigator.onLine){ el.innerText='Offline — cannot load server history'; return; }
  try{
    const res = await fetch(API_URL,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'getRecentSales', data:{limit:30}})});
    const json = await res.json();
    if(json.status==='success'){
      const rows = json.sales || [];
      if(!rows.length){ el.innerHTML = '<div class="small">No sales yet</div>'; return; }
      let html = '<table><thead><tr><th>Sale</th><th>Date</th><th>Customer</th><th class="right">Total</th></tr></thead><tbody>';
      rows.forEach(r=> html += `<tr><td>${r.SaleID}</td><td>${new Date(r.Date).toLocaleString()}</td><td>${r.CustomerID||'Walk-in'}</td><td class="right">${Number(r.TotalAmount||0).toFixed(2)}</td></tr>`);
      html += '</tbody></table>';
      el.innerHTML = html;
    } else el.innerText = 'Error loading sales';
  }catch(e){ el.innerText='Error fetching sales'; }
}

/* ---------------- BOOT ---------------- */
renderCart(); renderCartFull(); renderWhoami(); loadSalesHistory();

/* ---------------- INSTALL PROMPT ---------------- */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('installBtn').style.display='inline-block'; });
document.getElementById('installBtn').addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt=null; document.getElementById('installBtn').style.display='none'; });

/* ---------------- SERVICE WORKER REGISTER ---------------- */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').then(()=>console.log('SW OK')).catch(e=>console.warn('SW fail',e)); }

</script>
</body>
</html>
